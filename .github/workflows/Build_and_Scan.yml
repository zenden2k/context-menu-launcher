name: "ðŸš€ Build, Security Audit & Verification"

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  SOLUTION_FILE_PATH: .

jobs:
  # --- JOB 1: WINDOWS BUILD & NATIVE YARA ---
  build-windows:
    name: "ðŸ—ï¸ Build & Win-Audit (Win x86 ðŸªŸ)"
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: âš ï¸ Legal & Safety Notice
      shell: pwsh
      run: |
        "### ðŸ’€ CRITICAL SYSTEM NOTICE" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "> [!CAUTION]" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "> **USER BEWARE:** This autobuild is supplied without warranty. If the world ends, **it's not our fault.**" | Add-Content -Path $env:GITHUB_STEP_SUMMARY

    - name: âž• Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    - name: ðŸ—ï¸ NuGet Restore & Build
      run: |
        nuget restore ${{env.SOLUTION_FILE_PATH}}
        msbuild /m:8 /p:Configuration=Release ${{env.SOLUTION_FILE_PATH}}
        msbuild /m:8 /p:Configuration=ReleaseHidden ${{env.SOLUTION_FILE_PATH}}

    - name: ðŸ” Integrity Audit (SHA-256)
      shell: pwsh
      run: |
        $exe1 = "Release\singleinstance.exe"
        $exe2 = "Release\singleinstance_hidden.exe"
        $h1 = (Get-FileHash $exe1 -Algorithm SHA256).Hash.ToLower()
        $h2 = (Get-FileHash $exe2 -Algorithm SHA256).Hash.ToLower()
        
        # Write checksums for Linux (hash + space + space + filename)
        "$h1  singleinstance.exe" | Set-Content -Path Release\checksums.txt -Encoding Ascii
        "$h2  singleinstance_hidden.exe" | Add-Content -Path Release\checksums.txt

        "### ðŸ”’ Binary Integrity Report" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "| File | SHA-256 Checksum |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "| :--- | :--- |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "| **singleinstance.exe** | ``$h1`` |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "| **singleinstance_hidden.exe** | ``$h2`` |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY

   # --- JOB 2: YARA AUDIT (WINDOWS) ---
  yara-audit:
    name: "ðŸ›¡ï¸ YARA Audit"
    needs: build-windows
    runs-on: windows-latest
    steps:
    - name: ðŸ“¥ Download Binaries
      uses: actions/download-artifact@v4
      with:
        name: raw-binaries
        path: Release

    - name: ðŸ” Integrity Audit (SHA-256)
      shell: pwsh
      run: |
        $exe1 = "Release\singleinstance.exe"
        $exe2 = "Release\singleinstance_hidden.exe"
        $h1 = (Get-FileHash $exe1 -Algorithm SHA256).Hash.ToLower()
        $h2 = (Get-FileHash $exe2 -Algorithm SHA256).Hash.ToLower()
        
        # Write checksums for Linux (hash + space + space + filename)
        "$h1  singleinstance.exe" | Set-Content -Path Release\checksums.txt -Encoding Ascii
        "$h2  singleinstance_hidden.exe" | Add-Content -Path Release\checksums.txt

        "### ðŸ”’ Binary Integrity Report" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "| File | SHA-256 Checksum |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "| :--- | :--- |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "| **singleinstance.exe** | ``$h1`` |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "| **singleinstance_hidden.exe** | ``$h2`` |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY   

    - name: ðŸ›¡ï¸ Deep PE Audit with YARA
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://github.com/VirusTotal/yara/releases/download/v4.5.2/yara-v4.5.2-2326-win64.zip" -OutFile "yara.zip"
        Expand-Archive -Path "yara.zip" -DestinationPath "yara-bin" -Force
        $rule = 'import "pe" rule Win32_Executable_Audit { condition: uint16(0) == 0x5A4D and pe.subsystem == pe.SUBSYSTEM_WINDOWS_GUI }'
        $rule | Set-Content -Path "audit.yar" -Encoding Ascii

        "### ðŸ›¡ï¸ YARA Heuristic Analysis" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "| File | Match Result | Status |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "| :--- | :--- | :--- |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY

        $files = Get-ChildItem "Release\*.exe"
        foreach ($f in $files) {
            $res = ./yara-bin/yara64.exe -m audit.yar $f.FullName
            if ($res) {
                "| **$($f.Name)** | ``$($res.Trim())`` | âœ… VALID |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
            } else {
                "| **$($f.Name)** | No structural match | âŒ FAIL |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
                exit 1
            }
        }

    - name: ðŸ“¤ Upload Binaries for Linux Scan
      uses: actions/upload-artifact@v4
      with:
        name: build-binaries
        path: |
          Release/*.exe
          Release/checksums.txt

  # --- JOB 2: LINUX SECURITY SCAN ---
  security-scan:
    name: "ðŸ›¡ï¸ Security Audit (Linux ðŸ§)"
    needs: yara-audit
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¥ Download Binaries
      uses: actions/download-artifact@v4
      with:
        name: build-binaries
        path: scan-dir

    - name: ðŸ” Verify Transfer Integrity
      working-directory: scan-dir
      run: |
        echo "### ðŸ“‚ Cross-Platform Integrity Check" >> $GITHUB_STEP_SUMMARY
        if sha256sum -c checksums.txt; then
          echo "âœ… All hashes verified successfully on Linux." >> $GITHUB_STEP_SUMMARY
          
          # 2. Generate the matching report table
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | SHA-256 Checksum (Verified) |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          
          # Read the checksums file and format into table rows
          while read -r line; do
            hash=$(echo $line | awk '{print $1}')
            file=$(echo $line | awk '{print $2}')
            echo "| **$file** | \`$hash\` |" >> $GITHUB_STEP_SUMMARY
          done < checksums.txt
          
        else
          echo "âŒ **CRITICAL: Integrity check failed!** The files may have been corrupted during transfer." >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
        echo "---" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ›¡ï¸ ClamAV Virus Scan
      uses: hugoalh/scan-virus-ghaction@v0.20.1
      with:
        clamav_enable: true
        yara_enable: false
        found_summary: true
        statistics_summary: true

    - name: ðŸš€ Final Artifact Release
      uses: actions/upload-artifact@v4
      with:
        name: singleinstance-final-release
        path: scan-dir/*

    - name: ðŸ Final Clearance
      run: |
        echo "### âœ… Global Security Certification" >> $GITHUB_STEP_SUMMARY
        echo "1. **Windows Build Engine:** Verified compiled output." >> $GITHUB_STEP_SUMMARY
        echo "2. **YARA Audit:** Heuristic PE validation passed (Windows Native)." >> $GITHUB_STEP_SUMMARY
        echo "3. **Cross-Platform Check:** SHA-256 integrity verified via artifact handover." >> $GITHUB_STEP_SUMMARY
        echo "4. **ClamAV Engine:** Signature-based malware scan passed (Linux Native)." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "> [!IMPORTANT]" >> $GITHUB_STEP_SUMMARY
        echo "> All security gates passed successfully. Binaries are verified for distribution." >> $GITHUB_STEP_SUMMARY
