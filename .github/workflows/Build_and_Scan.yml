name: "ðŸš€ Build, Security Audit & Verification"

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  SOLUTION_FILE_PATH: .
  SESSION_KEY: ${{ github.run_id }}-${{ github.run_number }}

jobs:
  # --- JOB 1: BUILD & ENCRYPT ---
  build-windows:
    name: "ðŸ—ï¸ Build & Encrypt"
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    - name: âž• Add MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: ðŸ—ï¸ Build with Security Hardening
      run: |
        nuget restore ${{env.SOLUTION_FILE_PATH}}
        # Adding /p:ControlFlowGuard=Guard to enable CFG via MSBuild
        msbuild /m:8 /p:Configuration=Release /p:ControlFlowGuard=Guard ${{env.SOLUTION_FILE_PATH}}
        msbuild /m:8 /p:Configuration=ReleaseHidden /p:ControlFlowGuard=Guard ${{env.SOLUTION_FILE_PATH}}

    - name: ðŸ”’ Lock (Including PDBs for Audit)
      shell: pwsh
      run: |
        $h1 = (Get-FileHash Release\singleinstance.exe -Algorithm SHA256).Hash.ToLower()
        $h2 = (Get-FileHash Release\singleinstance_hidden.exe -Algorithm SHA256).Hash.ToLower()
        "$h1  singleinstance.exe" | Set-Content -Path Release\checksums.txt -Encoding Ascii
        "$h2  singleinstance_hidden.exe" | Add-Content -Path Release\checksums.txt
        
        # Include *.pdb so BinSkim can verify the internals
        7z a -p"${{ env.SESSION_KEY }}" "${{ runner.temp }}/encrypted_binaries.7z" ./Release/*.exe ./Release/*.pdb ./Release/checksums.txt
        
    - name: ðŸ“¤ Upload
      uses: actions/upload-artifact@v4
      with:
        name: locked-binaries
        path: ${{ runner.temp }}/encrypted_binaries.7z
        retention-days: 1

  # --- JOB 2: SECURITY AUDIT (WINDOWS) ---
  audit-windows:
    name: "ðŸ›¡ï¸ Windows Security Audit"
    needs: build-windows
    runs-on: windows-latest
    steps:
    - name: ðŸ“¥ Download
      uses: actions/download-artifact@v4
      with:
        name: locked-binaries
        path: ${{ runner.temp }}

    - name: ðŸ›¡ï¸ YARA & BinSkim Audit
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "$($env:RUNNER_TEMP)/audit"
        7z x -p"${{ env.SESSION_KEY }}" "$($env:RUNNER_TEMP)/encrypted_binaries.7z" -o"$($env:RUNNER_TEMP)/audit"

        # Setup YARA
        Invoke-WebRequest -Uri "https://github.com/VirusTotal/yara/releases/download/v4.5.2/yara-v4.5.2-2326-win64.zip" -OutFile "$($env:RUNNER_TEMP)/yara.zip"
        Expand-Archive -Path "$($env:RUNNER_TEMP)/yara.zip" -DestinationPath "$($env:RUNNER_TEMP)/yara-bin" -Force
        $rule = 'import "pe" rule Win32_Executable_Audit { condition: uint16(0) == 0x5A4D and pe.subsystem == pe.SUBSYSTEM_WINDOWS_GUI }'
        $rule | Set-Content -Path "$($env:RUNNER_TEMP)/audit.yar" -Encoding Ascii

        # Setup BinSkim
        Invoke-WebRequest -Uri "https://www.nuget.org/api/v2/package/Microsoft.CodeAnalysis.BinSkim/4.4.9" -OutFile "$($env:RUNNER_TEMP)/binskim.zip"
        Expand-Archive -Path "$($env:RUNNER_TEMP)/binskim.zip" -DestinationPath "$($env:RUNNER_TEMP)/binskim-bin" -Force
        $binskimExe = (Get-ChildItem -Path "$($env:RUNNER_TEMP)/binskim-bin" -Filter "BinSkim.exe" -Recurse | Select-Object -First 1).FullName

        "### ðŸ›¡ï¸ Heuristics & Hardening Report" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "| File | YARA Match | Status |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "| :--- | :--- | :--- |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY

        $files = Get-ChildItem "$($env:RUNNER_TEMP)/audit/*.exe"
        foreach ($f in $files) {
            $yaraRes = & "$($env:RUNNER_TEMP)/yara-bin/yara64.exe" -m "$($env:RUNNER_TEMP)/audit.yar" $f.FullName
            $cleanYara = $yaraRes.Replace(" []", "").Trim()
            
            # Run BinSkim. If it fails, the job will stop (which is good!)
            & $binskimExe analyze $f.FullName
            
            "| **$($f.Name)** | ``$cleanYara`` | âœ… HARDENED |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        }

  # --- JOB 3: LINUX SCAN & FINAL RELEASE ---
  security-scan:
    name: "ðŸ›¡ï¸ Final Linux Audit & Release"
    needs: audit-windows
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¥ Download
      uses: actions/download-artifact@v4
      with:
        name: locked-binaries
        path: ${{ runner.temp }}
    - name: ðŸ”“ Unlock
      run: |
        mkdir -p ./final-build
        7z x -p"${{ env.SESSION_KEY }}" "${{ runner.temp }}/encrypted_binaries.7z" -o./final-build
    - name: ðŸ” Verify
      working-directory: final-build
      run: |
        echo "### ðŸ“‚ Cross-Platform Integrity Check" >> $GITHUB_STEP_SUMMARY
        sha256sum -c checksums.txt
        echo "| File | SHA-256 Checksum (Verified) |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
        while read -r hash file; do
           echo "| **$file** | \`$hash\` |" >> $GITHUB_STEP_SUMMARY
        done < checksums.txt
    - name: ðŸ›¡ï¸ ClamAV Scan
      uses: hugoalh/scan-virus-ghaction@v0.20.1
      with:
        clamav_enable: true
        yara_enable: false
    - name: ðŸš€ FINAL RELEASE
      uses: actions/upload-artifact@v4
      with:
        name: singleinstance-FINAL-VERIFIED
        # Use a wildcard to EXCLUDE the PDBs from the final release if you want
        path: |
          final-build/*.exe
          final-build/checksums.txt
