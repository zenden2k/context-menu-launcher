name: "ðŸªŸ Build, Microsoft Defender Check & Verification"

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  SOLUTION_FILE_PATH: .

jobs:
  # --- JOB 1: WINDOWS BUILD ---
  build-windows:
    name: "ðŸ—ï¸ Build, Microsoft Defender Check & Verification (Win x86 ðŸªŸ) "
    runs-on: windows-latest
    outputs:
      hash1: ${{ steps.audit.outputs.hash1 }}
      hash2: ${{ steps.audit.outputs.hash2 }}
    steps:
    - uses: actions/checkout@v4

    - name: âš ï¸ Legal & Safety Notice
      shell: pwsh
      run: |
        "### ðŸ’€ CRITICAL SYSTEM NOTICE" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "> [!CAUTION]" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "> **USER BEWARE:** This autobuild is supplied without warranty. If the world ends, **it's not our fault.**" | Add-Content -Path $env:GITHUB_STEP_SUMMARY

    - name: âž• Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    - name: ðŸ—ï¸ NuGet Restore & Build
      run: |
        nuget restore ${{env.SOLUTION_FILE_PATH}}
        msbuild /m:8 /p:Configuration=Release ${{env.SOLUTION_FILE_PATH}}
        msbuild /m:8 /p:Configuration=ReleaseHidden ${{env.SOLUTION_FILE_PATH}}

    - name: ðŸ” Integrity Audit
      id: audit
      shell: pwsh
      run: |
        $exe1 = "Release\singleinstance.exe"
        $exe2 = "Release\singleinstance_hidden.exe"
        $h1 = (Get-FileHash $exe1 -Algorithm SHA256).Hash
        $h2 = (Get-FileHash $exe2 -Algorithm SHA256).Hash
        
        # Save for next job
        echo "hash1=$h1" >> $env:GITHUB_OUTPUT
        echo "hash2=$h2" >> $env:GITHUB_OUTPUT

        "### ðŸ”’ Binary Integrity Report" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "| File | SHA-256 Checksum |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "| :--- | :--- |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "| **singleinstance.exe** | ``$h1`` |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        "| **singleinstance_hidden.exe** | ``$h2`` |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
        
        "$h1  singleinstance.exe`n$h2  singleinstance_hidden.exe" | Out-File -FilePath Release\checksums.txt -Encoding ascii

    - name: ðŸ” Deep PE Audit (YARA)
      shell: pwsh
      run: |
        # 1. Download standalone YARA
        Invoke-WebRequest -Uri "https://github.com/VirusTotal/yara/releases/download/v4.5.2/yara-v4.5.2-2326-win64.zip" -OutFile "yara.zip"
        Expand-Archive -Path "yara.zip" -DestinationPath "yara-bin"
        
        # 2. Create a basic PE Audit Rule
        $rule = @"
        import "pe"
        rule Win32_Executable_Audit {
            condition:
                uint16(0) == 0x5A4D and pe.subsystem == pe.SUBSYSTEM_WINDOWS_GUI
        }
        "@
        $rule | Out-File -FilePath "audit.yar" -Encoding ascii

        # 3. Run the scan
        Write-Host "Starting Deep PE Audit..." -ForegroundColor Cyan
        ./yara-bin/yara64.exe -m audit.yar Release/singleinstance.exe
        ./yara-bin/yara64.exe -m audit.yar Release/singleinstance_hidden.exe
        
        "âœ… Deep PE Audit Complete (YARA 4.5.2)" | Add-Content -Path $env:GITHUB_STEP_SUMMARY  

    - name: ðŸ“¤ Upload for Scanning with ClamAV, Yara and Microsoft Defender under Linux ðŸ§
      uses: actions/upload-artifact@v4
      with:
        name: build-binaries
        path: Release/*.exe

  # --- JOB 2: LINUX SECURITY SCAN ---
  security-scan:
    name: "ðŸ›¡ï¸ Security Audit (Linux ðŸ§)"
    needs: build-windows
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¥ Download Binaries
      uses: actions/download-artifact@v4
      with:
        name: build-binaries
        path: scan-dir

    - name: ðŸ” Verify Transfer Integrity
      working-directory: scan-dir
      run: |
        echo "### ðŸ“‚ Cross-Platform Integrity Check" >> $GITHUB_STEP_SUMMARY
        sha256sum -c checksums.txt >> $GITHUB_STEP_SUMMARY 2>&1
        echo "---" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ›¡ï¸ Advanced Security Scan with ClamAV and Yara
      uses: hugoalh/scan-virus-ghaction@v0.20.1
      with:
        clamav_enable: true
        yara_enable: true
        found_summary: true
        statistics_summary: true
        # Ignore the broken internal YARA identifiers from PE and Magic not being present on Git Actions
        # Microsoft Defender above performs those checks
        ignores_post: |
          $input.Symbol -match 'extension' -or $input.Symbol -match 'filename'

    - name: ðŸ›¡ï¸ Microsoft Defender Scan (Linux)
      uses: jbrotsos/jbro-test-ghaction@v1
      with:
        # We tell it to scan the folder containing your artifacts
        args: "scan --path ./scan-dir"       

    # Move this here so it only uploads if BOTH build and scan passed
    - name: ðŸš€ Final Artifact Release
      uses: actions/upload-artifact@v4
      with:
        name: singleinstance-final-release
        path: scan-dir/*

    - name: ðŸ Final Clearance
      run: |
        echo "### âœ… Security Checks Passed" >> $GITHUB_STEP_SUMMARY
        echo "> [!IMPORTANT]" >> $GITHUB_STEP_SUMMARY
        echo "> These binaries have passed **Microsoft Defender**, **ClamAV**, **YARA**, and **SHA-256** validation on independent runners." >> $GITHUB_STEP_SUMMARY
